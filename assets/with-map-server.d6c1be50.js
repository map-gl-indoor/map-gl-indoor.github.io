import{e as v,f as l,l as A,p as D,r as c,h as M,i as m,I as O,a as I,b as T}from"./style.532636f9.js";import{m as N,a as E}from"./mapbox-gl.2e8cdf54.js";function u(w,o,a,s){s===void 0&&(s={});var r=v(w),i=l(r[0]),t=l(r[1]),e=l(a),n=A(o,s.units),d=Math.asin(Math.sin(t)*Math.cos(n)+Math.cos(t)*Math.sin(n)*Math.cos(e)),h=i+Math.atan2(Math.sin(e)*Math.sin(n)*Math.cos(t),Math.cos(n)-Math.sin(t)*Math.sin(d)),y=c(h),g=c(d);return D([y,g],s.properties)}const b=17,x=1e3;class p{serverUrl;map;remoteMapsDownloaded;downloadedBounds;loadMapsPromise=Promise.resolve();indoorMapOptions;constructor(o,a,s){this.serverUrl=o,this.map=a,this.indoorMapOptions=s,this.remoteMapsDownloaded=[],this.downloadedBounds=null,a.loaded()?this.loadMapsIfNecessary():a.on("load",()=>this.loadMapsIfNecessary()),a.on("move",()=>this.loadMapsIfNecessary())}loadMapsIfNecessary=async()=>{if(this.map.getZoom()<b)return;const o=this.map.getBounds();if(this.downloadedBounds!==null&&M(this.downloadedBounds,o.getNorthEast().toArray())&&M(this.downloadedBounds,o.getSouthWest().toArray()))return;const a=m(o.getNorthEast().toArray(),o.getNorthWest().toArray()),s=m(o.getNorthEast().toArray(),o.getSouthEast().toArray()),r=Math.max(a,s),i=Math.max(x,r*2),t=this.map.getCenter(),e=i*Math.sqrt(2),n=u(t.toArray(),e,Math.PI/4).geometry.coordinates,d=u(t.toArray(),e,-3*Math.PI/4).geometry.coordinates,h=[d[1],d[0],n[1],n[0]];this.downloadedBounds=h,await this.loadMapsPromise,this.loadMapsPromise=this.loadMapsInBounds(h)};loadMapsInBounds=async o=>{const a=this.serverUrl+`/maps-in-bounds/${o[0]},${o[1]},${o[2]},${o[3]}`,s=await(await fetch(a)).json(),r=this.remoteMapsDownloaded.reduce((t,e)=>(s.find(n=>n.path===e.path)||t.push(e),t),[]);s.reduce((t,e)=>(this.remoteMapsDownloaded.find(n=>n.path===e.path)||t.push(e),t),[]).forEach(this.addCustomMap),r.forEach(this.removeCustomMap)};addCustomMap=async o=>{const a=await(await fetch(this.serverUrl+o.path)).json();o.indoorMap=O.fromGeojson(a,this.indoorMapOptions),this.map.indoor.addMap(o.indoorMap),this.remoteMapsDownloaded.push(o)};removeCustomMap=async o=>{this.map.indoor.removeMap(o.indoorMap),this.remoteMapsDownloaded.splice(this.remoteMapsDownloaded.indexOf(o),1)};static manage(o,a,s){return new p(o,I(a),s)}}const B=document.querySelector("#app"),f=new N.exports.Map({container:B,zoom:18,center:[2.3592843,48.8767904],style:"mapbox://styles/mapbox/streets-v10",accessToken:E,hash:!0}),C="https://localhost:4001",R={beforeLayerId:"housenum-label",layersToHide:["poi-scalerank4-l15","poi-scalerank4-l1","poi-scalerank3","road-label-small"]};p.manage(C,f,R);f.addControl(new T);
//# sourceMappingURL=with-map-server.d6c1be50.js.map
